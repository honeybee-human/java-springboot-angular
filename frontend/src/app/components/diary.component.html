<div class="diary-container">
  <!-- Enhanced Header with Multiple Search Options -->
  <div class="diary-header">
    <div class="search-section">
      <!-- Basic Search -->
      <input 
        type="text" 
        placeholder="Search entries..." 
        [(ngModel)]="searchQuery"
        (input)="onSearch()"
        class="search-input">
      
      <!-- Title Search -->
      <input 
        type="text" 
        placeholder="Search by title..." 
        [(ngModel)]="titleSearchQuery"
        (input)="onAdvancedSearch()"
        class="search-input">
      
      <!-- Text Search -->
      <input 
        type="text" 
        placeholder="Search by text..." 
        [(ngModel)]="textSearchQuery"
        (input)="onAdvancedSearch()"
        class="search-input">
      
      <!-- Mood Filter -->
      <select [(ngModel)]="filterMood" (change)="onMoodFilter()" class="mood-filter">
        <option value="">All Moods</option>
        <option *ngFor="let mood of moods" [value]="mood">
          {{getMoodDisplay(mood).emoji}} {{getMoodDisplay(mood).description}}
        </option>
      </select>
    </div>
    <button class="add-btn" (click)="showAddForm = true">
      ‚úèÔ∏è New Entry
    </button>
  </div>

  <!-- Add/Edit Form -->
  <div *ngIf="showAddForm || editingEntry" class="entry-form-card">
    <h3>{{editingEntry ? 'Edit Entry' : 'New Diary Entry'}}</h3>
    <form (ngSubmit)="saveEntry()" #entryForm="ngForm">
      <div class="form-group">
        <label for="title">Title</label>
        <input 
          type="text" 
          id="title"
          [(ngModel)]="currentEntry.title" 
          name="title"
          required
          class="form-control">
      </div>
      
      <div class="form-group">
        <label for="mood">How are you feeling?</label>
        <div class="mood-selector">
          <div 
            *ngFor="let mood of moods" 
            class="mood-option"
            [class.selected]="currentEntry.mood === mood"
            (click)="currentEntry.mood = mood">
            <span class="mood-emoji">{{getMoodDisplay(mood).emoji}}</span>
            <span class="mood-label">{{getMoodDisplay(mood).description}}</span>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="content">Content</label>
        <textarea 
          id="content"
          [(ngModel)]="currentEntry.content" 
          name="content"
          required
          rows="6"
          class="form-control"
          placeholder="Write about your day..."></textarea>
      </div>
      
      <!-- Book Selection Section -->
      <div class="form-group">
        <label>Associated Book (Optional)</label>
        
        <!-- Selected Book Display -->
        <div *ngIf="currentEntry.associatedBook" class="selected-book">
          <div class="book-info">
            <img [src]="currentEntry.associatedBook.thumbnail || 'https://via.placeholder.com/60x90'" 
                 [alt]="currentEntry.associatedBook.title" class="book-thumbnail">
            <div class="book-details">
              <h4>{{currentEntry.associatedBook.title}}</h4>
              <p *ngIf="currentEntry.associatedBook.authors">by {{currentEntry.associatedBook.authors.join(', ')}}</p>
              <p *ngIf="currentEntry.associatedBook.description" class="book-description">
                {{truncateDescription(currentEntry.associatedBook.description)}}
              </p>
            </div>
            <button type="button" class="remove-book-btn" (click)="removeSelectedBook()">
              ‚úï
            </button>
          </div>
        </div>
        
        <!-- Book Search Toggle -->
        <div class="book-search-controls">
          <button type="button" class="search-books-btn" (click)="toggleBookSearch()">
            üìö {{showBookSearch ? 'Hide' : 'Search'}} Books
          </button>
        </div>
        
        <!-- Book Search Section -->
        <div *ngIf="showBookSearch" class="book-search-section">
          <!-- Saved Books -->
          <div class="saved-books-section">
            <h4>üìñ Your Saved Books</h4>
            <div *ngIf="savedBooks.length === 0" class="no-books">
              <p>No saved books yet. Search and save books from the Books tab first.</p>
            </div>
            <div *ngIf="savedBooks.length > 0" class="saved-books-grid">
              <div *ngFor="let book of savedBooks" class="saved-book-item" (click)="selectSavedBook(book)">
                <img [src]="book.thumbnail || 'https://via.placeholder.com/40x60'" 
                     [alt]="book.title" class="mini-thumbnail">
                <div class="mini-book-info">
                  <span class="mini-title">{{book.title}}</span>
                  <span *ngIf="book.authors" class="mini-author">{{book.authors[0]}}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Book Search -->
          <div class="book-search-form">
            <h4>üîç Search New Books</h4>
            <div class="book-search-inputs">
              <input 
                type="text" 
                placeholder="Search by description..." 
                [(ngModel)]="bookSearchQuery"
                name="bookSearch"
                class="book-search-input">
              <input 
                type="text" 
                placeholder="Search by title..." 
                [(ngModel)]="bookTitleQuery"
                name="bookTitle"
                class="book-search-input">
              <input 
                type="text" 
                placeholder="Search by author..." 
                [(ngModel)]="bookAuthorQuery"
                name="bookAuthor"
                class="book-search-input">
              <button type="button" class="search-btn" (click)="searchBooks()" [disabled]="isSearchingBooks">
                {{isSearchingBooks ? 'Searching...' : 'Search'}}
              </button>
            </div>
          </div>
          
          <!-- Book Search Results -->
          <div *ngIf="bookSearchResults.length > 0" class="book-results">
            <h4>Search Results</h4>
            <div class="book-results-grid">
              <div *ngFor="let book of bookSearchResults" class="book-result-item" (click)="selectBook(book)">
                <img [src]="book.thumbnail || 'https://via.placeholder.com/50x75'" 
                     [alt]="book.title" class="result-thumbnail">
                <div class="result-book-info">
                  <h5>{{book.title}}</h5>
                  <p *ngIf="book.authors">by {{book.authors.join(', ')}}</p>
                  <p *ngIf="book.description" class="result-description">
                    {{truncateDescription(book.description, 80)}}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="tags">Tags (comma separated)</label>
        <input 
          type="text" 
          id="tags"
          [(ngModel)]="tagsString" 
          name="tags"
          class="form-control"
          placeholder="work, family, travel">
      </div>
      
      <div class="form-actions">
        <button type="submit" class="save-btn" [disabled]="!entryForm.valid">
          {{editingEntry ? 'Update' : 'Save'}} Entry
        </button>
        <button type="button" class="cancel-btn" (click)="cancelEdit()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Entries List -->
  <div class="entries-list">
    <div *ngIf="loading" class="loading">Loading entries...</div>
    <div *ngIf="!loading && entries.length === 0" class="no-entries">
      <p>No diary entries yet. Start writing your first entry!</p>
    </div>
    
    <div *ngFor="let entry of entries" class="entry-card">
      <div class="entry-header">
        <h3 class="entry-title">{{entry.title}}</h3>
        <div class="entry-mood">
          <span class="mood-display">
            {{getMoodDisplay(entry.mood).emoji}} {{getMoodDisplay(entry.mood).description}}
          </span>
        </div>
      </div>
      
      <!-- Associated Book Display -->
      <div *ngIf="entry.associatedBook" class="entry-book">
        <div class="book-reference">
          <img [src]="entry.associatedBook.thumbnail || 'https://via.placeholder.com/40x60'" 
               [alt]="entry.associatedBook.title" class="entry-book-thumbnail">
          <div class="entry-book-info">
            <span class="entry-book-title">üìö {{entry.associatedBook.title}}</span>
            <span *ngIf="entry.associatedBook.authors" class="entry-book-author">
              by {{entry.associatedBook.authors.join(', ')}}
            </span>
          </div>
        </div>
      </div>
      
      <div class="entry-meta">
        <span class="entry-date">{{formatDate(entry.createdAt)}}</span>
        <div class="entry-tags">
          <span *ngFor="let tag of entry.tags" class="tag">{{tag}}</span>
        </div>
      </div>
      
      <div class="entry-content">
        <p>{{entry.content}}</p>
      </div>
      
      <div class="entry-actions">
        <button class="edit-btn" (click)="editEntry(entry)">‚úèÔ∏è Edit</button>
        <button class="delete-btn" (click)="deleteEntry(entry.id!)">
          üóëÔ∏è Delete
        </button>
      </div>
    </div>
  </div>
</div>